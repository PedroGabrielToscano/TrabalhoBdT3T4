package services;

import database.PostgresDatabaseConnection;
import model.Fatura;
import model.MotivoFatura;

import java.sql.*;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

public class FaturaService {

    /**
     * Retorna todas as faturas de um fornecedor espec√≠fico, 
     * junto com o motivo da fatura (JOIN na tabela MotivoFatura).
     */
    public List<Fatura> listarFaturasPorFornecedor(int idFornecedor) {
        List<Fatura> lista = new ArrayList<>();

        String sql = "SELECT fat.idfatura, fat.valorFatura, fat.dtvencimento, fat.dtlancamento, "
                   + "       mot.idmotivo, mot.motivo "
                   + "FROM fatura fat "
                   + "JOIN motivofatura mot ON fat.idmotivo = mot.idmotivo "
                   + "WHERE fat.idfornecedor = ?";

        try (Connection conn = PostgresDatabaseConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setInt(1, idFornecedor);
            ResultSet rs = ps.executeQuery();

            while (rs.next()) {
                Fatura fatura = new Fatura();
                fatura.setIdFatura(rs.getInt("idfatura"));
                fatura.setValorFatura(rs.getDouble("valorFatura"));
                fatura.setDtVencimento(rs.getDate("dtvencimento").toLocalDate());
                fatura.setDtLancamento(rs.getDate("dtlancamento").toLocalDate());
                
                MotivoFatura motivo = new MotivoFatura();
                motivo.setIdMotivo(rs.getInt("idmotivo"));
                motivo.setMotivo(rs.getString("motivo"));
                fatura.setMotivoFatura(motivo);

                lista.add(fatura);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }

        return lista;
    }
}
