package transacao;

import database.PostgresDatabaseConnection;
import java.sql.*;
import java.time.LocalDate;

public class TransacaoOK {
    public static void executarTransacaoOK() {
        Connection conn = null;
        try {
            conn = PostgresDatabaseConnection.getConnection();
            conn.setAutoCommit(false);
            
            // INSERT em fatura
            String sqlInsert = "INSERT INTO fatura (idfatura, idfornecedor, valorfatura, idmotivo, dtvencimento, dtlancamento) " +
                               "VALUES (?, ?, ?, ?, ?, ?)";
            try (PreparedStatement psInsert = conn.prepareStatement(sqlInsert)) {
                int novoIdFatura = 1001; // Exemplo
                psInsert.setInt(1, novoIdFatura);
                psInsert.setInt(2, 1); // ID do fornecedor
                psInsert.setDouble(3, 500.0);
                psInsert.setInt(4, 1); // ID do motivo
                psInsert.setDate(5, Date.valueOf(LocalDate.now().plusDays(30)));
                psInsert.setDate(6, Date.valueOf(LocalDate.now()));
                psInsert.executeUpdate();
            }
            
            // UPDATE em fornecedor
            String sqlUpdate = "UPDATE fornecedor SET saldoapagar = saldoapagar + ? WHERE idfornecedor = ?";
            try (PreparedStatement psUpdate = conn.prepareStatement(sqlUpdate)) {
                psUpdate.setDouble(1, 500.0);
                psUpdate.setInt(2, 1);
                psUpdate.executeUpdate();
            }
            
            conn.commit();
            System.out.println("Transação OK concluída com sucesso!");
        } catch (Exception e) {
            try {
                if (conn != null) {
                    conn.rollback();
                }
            } catch (SQLException se) {
                se.printStackTrace();
            }
            System.err.println("Erro na transação OK: " + e.getMessage());
        } finally {
            try {
                if (conn != null && !conn.isClosed()){
                    conn.close();
                }
            } catch (SQLException se) {
                se.printStackTrace();
            }
        }
    }
}
